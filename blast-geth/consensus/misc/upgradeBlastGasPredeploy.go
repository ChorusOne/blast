package misc

import (
	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/core/vm"
	"github.com/ethereum/go-ethereum/log"
	"github.com/ethereum/go-ethereum/params"
)

// Blast gas predeploy is not put behind a proxy for testnet
// this hard fork updates the predeploy with correct implementation
const UpdatedGasPredeployBytecodeObject string = "608060405234801561001057600080fd5b506004361061010b5760003560e01c806361da985e116100a2578063d45e6bdf11610071578063d45e6bdf14610222578063d4810ba514610249578063dde798a41461025c578063f5c5e3431461027f578063f851a4401461028857600080fd5b806361da985e146101a957806388e5f229146101e8578063aaa2f64314610210578063bafe80961461021957600080fd5b8063445067cb116100de578063445067cb14610165578063494588681461017a5780635767bba51461018d5780635a03838f146101a057600080fd5b80630951888f14610110578063150111191461013657806326af48321461013f5780632d7a59e114610152575b600080fd5b61012361011e366004610c63565b6102af565b6040519081526020015b60405180910390f35b61012360035481565b61012361014d366004610c9f565b6103f6565b610123610160366004610ce1565b6105d1565b610178610173366004610cfc565b610695565b005b610123610188366004610d37565b61090b565b61012361019b366004610d37565b61091a565b61012360005481565b6101d07f000000000000000000000000430000000000000000000000000000000000000281565b6040516001600160a01b03909116815260200161012d565b6101fb6101f6366004610d6a565b610943565b6040805192835260208301919091520161012d565b61012360015481565b61012360045481565b6101d07f000000000000000000000000420000000000000000000000000000000000001981565b610178610257366004610d8c565b610a08565b61026f61026a366004610ce1565b610a74565b60405161012d9493929190610ddd565b61012360025481565b6101d07f000000000000000000000000a6b8cfd7588f6d52b3913c520894facd3fbc1a1e81565b60006004548211156103135760405162461bcd60e51b815260206004820152602260248201527f6465736972656420636c61696d20726174652065786365656473206d6178696d604482015261756d60f01b60648201526084015b60405180910390fd5b60008061031f86610a74565b505091509150600054841161034157610338868661091a565b925050506103ef565b6002548410156103515760025493505b6000600254856103619190610e35565b905060006001546003546103759190610e35565b905060006002546004546103899190610e35565b90506000816103988486610e4c565b6103a29190610e6b565b6001546103af9190610e8d565b905060006103bd8288610e6b565b9050858111156103ca5750845b60006103d68383610e4c565b90506103e48c8c84846103f6565b985050505050505050505b9392505050565b6000336001600160a01b037f000000000000000000000000430000000000000000000000000000000000000216146104405760405162461bcd60e51b815260040161030a90610ea5565b600080600061044e88610a74565b93505092509250600086116104a55760405162461bcd60e51b815260206004820152601d60248201527f6d757374207769746864726177206e6f6e2d7a65726f20616d6f756e74000000604482015260640161030a565b818611156104ec5760405162461bcd60e51b8152602060048201526014602482015273746f6f206d75636820746f20776974686472617760601b604482015260640161030a565b828511156105355760405162461bcd60e51b81526020600482015260166024820152756e6f7420656e6f75676820676173207365636f6e647360501b604482015260640161030a565b6000806105428789610943565b90925090506000612710610556848b610e4c565b6105609190610e6b565b9050600061056e828b610e35565b905061058e8c61057e858a610e35565b6105888d8a610e35565b88610b20565b6105988b83610bf6565b6105c27f000000000000000000000000420000000000000000000000000000000000001982610bf6565b509a9950505050505050505050565b6000336001600160a01b037f000000000000000000000000a6b8cfd7588f6d52b3913c520894facd3fbc1a1e16146106455760405162461bcd60e51b815260206004820152601760248201527621b0b63632b91034b9903737ba103a34329030b236b4b760491b604482015260640161030a565b600061065083610a74565b5050915050610663836000806000610b20565b61068d7f000000000000000000000000420000000000000000000000000000000000001982610bf6565b90505b919050565b336001600160a01b037f000000000000000000000000a6b8cfd7588f6d52b3913c520894facd3fbc1a1e16146107075760405162461bcd60e51b815260206004820152601760248201527621b0b63632b91034b9903737ba103a34329030b236b4b760491b604482015260640161030a565b8285106107685760405162461bcd60e51b815260206004820152602960248201527f7a65726f20636c61696d2072617465206d757374206265203c206261736520636044820152686c61696d207261746560b81b606482015260840161030a565b8083106107c95760405162461bcd60e51b815260206004820152602960248201527f6261736520636c61696d2072617465206d757374206265203c206365696c20636044820152686c61696d207261746560b81b606482015260840161030a565b81841061082c5760405162461bcd60e51b815260206004820152602b60248201527f6261736520676173207365636f6e6473206d757374206265203c206365696c2060448201526a676173207365636f6e647360a81b606482015260840161030a565b6000841161087c5760405162461bcd60e51b815260206004820152601c60248201527f6261736520676173207365636f6e6473206d757374206265203e203000000000604482015260640161030a565b6127108111156108f45760405162461bcd60e51b815260206004820152603960248201527f6365696c20636c61696d2072617465206d757374206265206c6573732074686160448201527f6e206f7220657175616c20746f2031305f303030206269707300000000000000606482015260840161030a565b600094909455600192909255600255600355600455565b60006103ef83836004546102af565b600080600061092885610a74565b50509150915061093a858583856103f6565b95945050505050565b600080806109518486610e6b565b905060015481101561096a575050600080549150610a01565b6003548110610992576000600354856109839190610e4c565b60045494509250610a01915050565b60006002546004546109a49190610e35565b905060006001546003546109b89190610e35565b90506000600154846109ca9190610e35565b90506000826109d98386610e4c565b6109e39190610e6b565b90506000816002546109f59190610e8d565b97508996505050505050505b9250929050565b336001600160a01b037f00000000000000000000000043000000000000000000000000000000000000021614610a505760405162461bcd60e51b815260040161030a90610ea5565b600080610a5c84610a74565b505091509150610a6e84838386610b20565b50505050565b600080600080600085604051602001610a8d9190610ef0565b60408051601f19818403018152919052805160209091012080549091508060001a6001811115610abf57610abf610dc7565b6effffffffffffffffffffffffffffff602083901c1696506bffffffffffffffffffffffff609883901c16955063ffffffff821694509250610b018442610e35565b610b0b9086610e4c565b610b159087610e8d565b955050509193509193565b600160601b82101580610b375750600160781b8310155b15610b955760405162461bcd60e51b815260206004820152602860248201527f556e6578706563746564207061636b696e672069737375652064756520746f206044820152676f766572666c6f7760c01b606482015260840161030a565b6040514290600090610bab908790602001610ef0565b60408051601f1981840301815291905280516020918201209150600090839087901b609887901b60f8876001811115610be657610be6610dc7565b901b171717909155505050505050565b600080600080600085875af1905080610c475760405162461bcd60e51b815260206004820152601360248201527211551217d514905394d1915497d19052531151606a1b604482015260640161030a565b505050565b80356001600160a01b038116811461069057600080fd5b600080600060608486031215610c7857600080fd5b610c8184610c4c565b9250610c8f60208501610c4c565b9150604084013590509250925092565b60008060008060808587031215610cb557600080fd5b610cbe85610c4c565b9350610ccc60208601610c4c565b93969395505050506040820135916060013590565b600060208284031215610cf357600080fd5b6103ef82610c4c565b600080600080600060a08688031215610d1457600080fd5b505083359560208501359550604085013594606081013594506080013592509050565b60008060408385031215610d4a57600080fd5b610d5383610c4c565b9150610d6160208401610c4c565b90509250929050565b60008060408385031215610d7d57600080fd5b50508035926020909101359150565b60008060408385031215610d9f57600080fd5b610da883610c4c565b9150602083013560028110610dbc57600080fd5b809150509250929050565b634e487b7160e01b600052602160045260246000fd5b84815260208101849052604081018390526080810160028310610e1057634e487b7160e01b600052602160045260246000fd5b82606083015295945050505050565b634e487b7160e01b600052601160045260246000fd5b600082821015610e4757610e47610e1f565b500390565b6000816000190483118215151615610e6657610e66610e1f565b500290565b600082610e8857634e487b7160e01b600052601260045260246000fd5b500490565b60008219821115610ea057610ea0610e1f565b500190565b6020808252602b908201527f43616c6c6572206d75737420626520626c61737420636f6e666967757261746960408201526a1bdb8818dbdb9d1c9858dd60aa1b606082015260800190565b60609190911b6bffffffffffffffffffffffff1916815269706172616d657465727360b01b6014820152601e019056fea164736f6c634300080f000a"

var UpdatedGasPredeployBytecode []byte = common.Hex2Bytes(UpdatedGasPredeployBytecodeObject)

func EnsureUpdateGas(c *params.ChainConfig, timestamp uint64, db vm.StateDB) {
	if !c.IsOptimism() || c.CanyonTime == nil || *c.CanyonTime > timestamp {
		return
	}
	// TODO(blast): add this to the chain config as a new fork option
	if timestamp != params.BlastTestnetPredeployForkTime {
		return
	}

	log.Info("Setting Gas code at address", params.BlastGasAddress)
	db.SetCode(params.BlastGasAddress, UpdatedGasPredeployBytecode)
}
